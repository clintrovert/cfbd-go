name: Release on Merge

on:
  pull_request:
    types: [closed]
  push:
    branches:
      - main
      - master

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    # Only run if PR was merged (not just closed) or if it's a direct push to main/master
    if: |
      (github.event.pull_request.merged == true) ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate next version
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          
          # Remove 'v' prefix if present
          LATEST_VERSION=${LATEST_TAG#v}
          
          # Parse version components using awk for better compatibility
          MAJOR=$(echo "$LATEST_VERSION" | awk -F. '{print $1}')
          MINOR=$(echo "$LATEST_VERSION" | awk -F. '{print $2}')
          PATCH=$(echo "$LATEST_VERSION" | awk -F. '{print $3}')
          
          # Default to 0.0.0 if no tags exist or parsing failed
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          
          # Get the branch name from PR or commit
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PR merge, get the head ref (source branch)
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          else
            # For direct push, try to extract from commit message or use default
            # Check if commit message contains branch info
            COMMIT_MSG=$(git log -1 --pretty=%B)
            if echo "$COMMIT_MSG" | grep -qiE "from (major|minor|patch)/"; then
              BRANCH_NAME=$(echo "$COMMIT_MSG" | grep -oiE "from (major|minor|patch)/[^ ]*" | head -1 | sed 's/from //')
            else
              # Default to patch for direct pushes without branch info
              BRANCH_NAME="patch/default"
            fi
          fi
          
          # Determine bump type based on branch name prefix
          if echo "$BRANCH_NAME" | grep -qiE "^major/"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          elif echo "$BRANCH_NAME" | grep -qiE "^minor/"; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          elif echo "$BRANCH_NAME" | grep -qiE "^patch/"; then
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          else
            # Default to patch if no prefix is found
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          fi
          
          NEXT_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          
          # Check if tag already exists
          if git rev-parse "$NEXT_VERSION" >/dev/null 2>&1; then
            echo "Tag $NEXT_VERSION already exists, skipping release"
            echo "skip_release=true" >> $GITHUB_OUTPUT
          else
            echo "skip_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "current_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create Git Tag
        if: steps.version.outputs.skip_release != 'true'
        run: |
          git tag -a "${{ steps.version.outputs.next_version }}" -m "Release ${{ steps.version.outputs.next_version }}"
          git push origin "${{ steps.version.outputs.next_version }}"

      - name: Generate Release Notes
        if: steps.version.outputs.skip_release != 'true'
        id: release_notes
        run: |
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"
          NEXT_VERSION="${{ steps.version.outputs.next_version }}"
          
          # Get commits since last tag
          if [ "$LATEST_TAG" != "v0.0.0" ]; then
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -10)
          fi
          
          NOTES="## What's Changed
          
          $COMMITS
          
          **Full Changelog**: ${{ github.server_url }}/${{ github.repository }}/compare/$LATEST_TAG...$NEXT_VERSION"
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.version.outputs.skip_release != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = '${{ steps.version.outputs.next_version }}';
            const releaseName = `Release ${tagName}`;
            const body = `${{ steps.release_notes.outputs.notes }}`;
            
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: releaseName,
              body: body,
              draft: false,
              prerelease: false
            });

      - name: Release Summary
        if: always()
        run: |
          if [ "${{ steps.version.outputs.skip_release }}" == "true" ]; then
            echo "## ⚠️ Release Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Tag \`${{ steps.version.outputs.next_version }}\` already exists. No new release was created." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ Release Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Version**: \`${{ steps.version.outputs.next_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Bump Type**: ${{ steps.version.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Previous Version**: \`${{ steps.version.outputs.latest_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch**: \`${{ steps.version.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.next_version }}" >> $GITHUB_STEP_SUMMARY
          fi

